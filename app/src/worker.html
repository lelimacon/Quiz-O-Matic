<!doctype html>
<html>

<head>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

</head>

<body>
    <div id="toto">Still here</div>

</body>

<script type="module">
import {
    $typst,
    preloadRemoteFonts,
} from "https://cdn.jsdelivr.net/npm/@myriaddreamin/typst.ts/dist/esm/contrib/all-in-one-lite.bundle.js"
// DOC: https://myriad-dreamin.github.io/typst.ts/cookery/guide/all-in-one.html

import { elementFromHTML } from "./lib/utils.js"
import { lengths, getLevelIndex } from "./lib/constants.js"


let isReady = false

const fetchText = (path) => fetch(path).then(r => r.text())
const dirFromPath = (path) => path.substring(0, path.lastIndexOf("/") + 1)

const init = async () =>
{
    console.log("Typst initializing")

    $typst.setCompilerInitOptions
    ({
        beforeBuild:
        [
            preloadRemoteFonts
            ([
                "/template/res/LuckiestGuy-Regular.ttf",
                "/template/res/Quicksand-Regular.ttf",
                "/template/res/Quicksand-Bold.ttf",

                // Emoji font is automatically used.
                "/template/res/NotoEmoji-VariableFont_wght.ttf",
            ]),
        ],
        getModule: () => "https://cdn.jsdelivr.net/npm/@myriaddreamin/typst-ts-web-compiler/pkg/typst_ts_web_compiler_bg.wasm",
    })
    $typst.setRendererInitOptions
    ({
        getModule: () => "https://cdn.jsdelivr.net/npm/@myriaddreamin/typst-ts-renderer/pkg/typst_ts_renderer_bg.wasm",
    })

    const add = async (path) =>
    {
        //console.log("ADD", path)
        const text = await fetchText(`/template${path}`)
        await $typst.addSource(path, text)
    }

    await add("/builder.typ")
    await add("/entities.typ")
    await add("/constants.typ")
    await add("/main.typ")
    await add("/random.typ")
    await add("/theme-answers.typ")
    await add("/utils.typ")

    console.log("Typst ready")
}

const loadSource = async (source) =>
{
    console.log("Source loading", `Base URL: ${source.baseUrl}`)

    const add = async (path) =>
    {
        //console.log("INNER ADD", path)
        const text = await fetchText(`${source.baseUrl}${path}`)
        return $typst.addSource(`/${path}`, text)
    }

    const addAssets = async (assets, baseDir) =>
    {
        if (!assets)
            return

        for (const assetName of assets)
        {
            const assetPath = `${baseDir}${assetName}`
            await add(assetPath)
        }
    }

    for (const exercise of source.exercises)
    {
        //console.log("exercise", exercise)
        await add(exercise.path)
        await addAssets(exercise.assets, dirFromPath(exercise.path))
    }

    for (const theme of source.themes)
    {
        await add(theme.path)
        await addAssets(theme.assets, dirFromPath(theme.path))
    }

    console.log("Source loaded")
}

const generateData = (quiz) =>
{
    const exercises = quiz.exercises.map(e =>
    { return {
        path: e.path,
        seed: e.seed,
        level: getLevelIndex(e.levelScale, e.selectedLevel),
        length: lengths[e.selectedLength],
    }})

    const data =
    {
        mode: parseInt(quiz.mode),
        theme: quiz.theme,
        title: quiz.title,
        subtitle: quiz.subtitle,
        date: quiz.date,
        exercises,
    }

    return data
}

export const renderSvg = async (quiz) =>
{
    if (!isReady)
    {
        return;
    }

    const data = generateData(quiz)

    const encoder = new TextEncoder()
    $typst.mapShadow('/data.json', encoder.encode(JSON.stringify(data)))

    const svg = await $typst.svg()
    return svg
}

window.addEventListener("message", async (e) =>
{
    console.log("Received message")

    const message = JSON.parse(e.data)
    if (message.action == "loadSource")
    {
        await loadSource(message.payload)
    }
    if (message.action == "renderSvg")
    {
        await renderSvg(message.payload)
    }

    //e.source.postMessage({ result }, '*')
})


window.workerChannel =
{
    loadSource: async (source) => await loadSource(source),
    renderSvg: async (quiz) => await renderSvg(quiz),
}

/*
await init()
isReady = true

//parent.postMessage(JSON.stringify({ action: "ready" }))
parent.workerChannel.ready()
*/

</script>

</html>
